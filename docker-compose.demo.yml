# Demo standalone compose for VPS deployment.
# Usage: docker compose -f docker-compose.demo.yml up -d
#
# Pre-loaded weather snapshot, no external API credentials needed.
# Caddy reverse proxy routes /api/* to the API and everything else to the frontend.

services:
  db:
    image: postgres:16-alpine
    container_name: windmar-db
    environment:
      POSTGRES_USER: windmar
      POSTGRES_PASSWORD: ${DEMO_DB_PASSWORD:?DEMO_DB_PASSWORD env var required}
      POSTGRES_DB: windmar
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./data/demo-snapshot.sql.gz:/docker-entrypoint-initdb.d/02-demo-data.sql.gz
      - ./data/demo-engine-log-seed.sql:/docker-entrypoint-initdb.d/03-engine-log-seed.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U windmar"]
      interval: 15s
      timeout: 10s
      retries: 30
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped

  api:
    image: ghcr.io/windmar-nav/windmar-api:demo
    container_name: windmar-api
    env_file:
      - .env.hashes
    environment:
      DATABASE_URL: postgresql://windmar:${DEMO_DB_PASSWORD:?DEMO_DB_PASSWORD env var required}@db:5432/windmar
      REDIS_ENABLED: "false"
      REDIS_URL: ""
      DEMO_MODE: "true"
      AUTH_ENABLED: "false"
      RATE_LIMIT_ENABLED: "true"
      API_SECRET_KEY: ${API_SECRET_KEY:-change_me}
      CORS_ORIGINS: "https://demo-windmar.slmar.co,http://localhost:3000"
      LOG_LEVEL: "info"
      ENVIRONMENT: "demo"
    expose:
      - "8000"
    depends_on:
      db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 2G
    command: ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]
    restart: unless-stopped

  frontend:
    image: ghcr.io/windmar-nav/windmar-frontend:demo
    container_name: windmar-frontend
    init: true
    expose:
      - "3000"
    depends_on:
      - api
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: windmar-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
    depends_on:
      - api
      - frontend
    deploy:
      resources:
        limits:
          memory: 128M
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  caddy_data:
    driver: local
